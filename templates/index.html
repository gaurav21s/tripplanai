{% extends 'base.html' %}

{% block title %}Dashboard - TravelPlanAI{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div class="container">
            <h1>Create Your Perfect Trip</h1>
            <p>Tell us what you're looking for, and our AI will craft the perfect travel plan tailored to your preferences.</p>
            <!-- <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showSavedPlans()">
                    <i class="fas fa-list"></i> View Saved Plans
                </button>
                <button class="btn btn-secondary" onclick="promptLoadPlan()">
                    <i class="fas fa-upload"></i> Load Saved Plan
                </button>
            </div> -->
        </div>
    </div>


    <div class="trip-builder">
        <div class="container">
            <div id="tripForm" class="step-container">
                <!-- Enhanced Progress Bar -->
                <div class="progress-wrapper">
                    <div class="progress-line">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="steps-header">
                        <div class="step active" data-step="1">
                            <div class="step-circle">
                                <div class="step-number">1</div>
                                <div class="step-icon"><i class="fas fa-map-marker-alt"></i></div>
                            </div>
                            <div class="step-label">
                                <div class="step-title">Destination</div>
                                <div class="step-subtitle">Where to go?</div>
                            </div>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-circle">
                                <div class="step-number">2</div>
                                <div class="step-icon"><i class="fas fa-calendar-alt"></i></div>
                            </div>
                            <div class="step-label">
                                <div class="step-title">Trip Details</div>
                                <div class="step-subtitle">Plan duration</div>
                            </div>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-circle">
                                <div class="step-number">3</div>
                                <div class="step-icon"><i class="fas fa-heart"></i></div>
                            </div>
                            <div class="step-label">
                                <div class="step-title">Interests</div>
                                <div class="step-subtitle">What you love</div>
                            </div>
                        </div>
                        <div class="step" data-step="4">
                            <div class="step-circle">
                                <div class="step-number">4</div>
                                <div class="step-icon"><i class="fas fa-check-circle"></i></div>
                            </div>
                            <div class="step-label">
                                <div class="step-title">Review</div>
                                <div class="step-subtitle">Almost there!</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Destination -->
                <div class="step-content step-slide" id="step1">
                    <div class="step-content-inner">
                        <div class="step-header-animated">
                            <div class="step-icon-large">
                                <i class="fas fa-globe-americas"></i>
                            </div>
                            <h2 class="animated-title">Where do you want to go?</h2>
                            <p class="step-description">Choose a specific destination or let our AI suggest the perfect place for you</p>
                        </div>
                        
                        <div class="form-content">
                            <div class="form-group">
                                <label class="form-label">I want to:</label>
                                <div class="radio-cards">
                                    <div class="radio-card" data-value="specific">
                                        <input type="radio" id="specific-destination" name="destination-type" value="specific" checked>
                                        <label for="specific-destination">
                                            <div class="card-icon"><i class="fas fa-map-pin"></i></div>
                                            <div class="card-title">Choose Destination</div>
                                            <div class="card-desc">I know where I want to go</div>
                                        </label>
                                    </div>
                                    <div class="radio-card" data-value="suggest">
                                        <input type="radio" id="ai-suggest" name="destination-type" value="suggest">
                                        <label for="ai-suggest">
                                            <div class="card-icon"><i class="fas fa-magic"></i></div>
                                            <div class="card-title">Surprise Me</div>
                                            <div class="card-desc">Let AI suggest a place</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="specific-destination-form" class="form-section">
                                <div class="form-group">
                                    <label for="selected-city" class="form-label">
                                        <i class="fas fa-search"></i> Destination:
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="text" id="selected-city" class="form-control enhanced-input" placeholder="e.g., Paris, France">
                                        <div class="input-icon"><i class="fas fa-map-marker-alt"></i></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="start-city-form" class="form-section">
                                <div class="form-group">
                                    <label for="start-city" class="form-label">
                                        <i class="fas fa-plane-departure"></i> Where will you be traveling from?
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="text" id="start-city" class="form-control enhanced-input" placeholder="e.g., New York, USA" required>
                                        <div class="input-icon"><i class="fas fa-home"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" id="nextToStep2" class="btn btn-next">
                                <span>Next: Trip Details</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Trip Details -->
                <div class="step-content step-slide" id="step2" style="display: none;">
                    <div class="step-content-inner">
                        <div class="step-header-animated">
                            <div class="step-icon-large">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h2 class="animated-title">Plan Your Perfect Trip</h2>
                            <p class="step-description">Tell us about your trip duration, season, and budget preferences to create the ideal itinerary</p>
                        </div>
                        
                        <div class="form-content">
                            <div class="form-section">
                                <div class="form-group">
                                    <label for="duration" class="form-label">
                                        <i class="fas fa-clock"></i> How many days?
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="duration" class="enhanced-input" min="1" max="30" value="5" required>
                                        <div class="input-icon"><i class="fas fa-calendar-day"></i></div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="people" class="form-label">
                                        <i class="fas fa-users"></i> Number of travelers:
                                    </label>
                                    <div class="input-wrapper">
                                        <input type="number" id="people" class="enhanced-input" min="1" max="20" value="2" required>
                                        <div class="input-icon"><i class="fas fa-user-friends"></i></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-group">
                                    <label for="season" class="form-label">
                                        <i class="fas fa-cloud-sun"></i> What season will you be traveling in?
                                    </label>
                                    <div class="input-wrapper">
                                        <select id="season" class="enhanced-input" required>
                                            <option value="">Select season</option>
                                            <option value="Summer">Summer</option>
                                            <option value="Fall">Fall</option>
                                            <option value="Winter">Winter</option>
                                            <option value="Spring">Spring</option>
                                            <option value="Rainy">Rainy</option>
                                            <option value="Dry">Dry</option>
                                        </select>
                                        <div class="input-icon"><i class="fas fa-chevron-down"></i></div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="budget-currency" class="form-label">
                                        <i class="fas fa-coins"></i> Currency:
                                    </label>
                                    <div class="input-wrapper">
                                        <select id="budget-currency" class="enhanced-input" required>
                                            <option value="inr">INR (Indian Rupee)</option>
                                            <option value="usd">USD (US Dollar)</option>
                                            <option value="eur">EUR (Euro)</option>
                                            <option value="gbp">GBP (British Pound)</option>
                                            <option value="jpy">JPY (Japanese Yen)</option>
                                        </select>
                                        <div class="input-icon"><i class="fas fa-chevron-down"></i></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-dollar-sign"></i> What's your budget?
                                    </label>
                                    <div class="budget-cards">
                                        <div class="budget-card" data-value="low">
                                            <div class="budget-icon">
                                                <i class="fas fa-wallet"></i>
                                            </div>
                                            <div class="budget-title">Budget</div>
                                            <div class="budget-desc">Cost-effective options</div>
                                        </div>
                                        <div class="budget-card selected" data-value="medium">
                                            <div class="budget-icon">
                                                <i class="fas fa-balance-scale"></i>
                                            </div>
                                            <div class="budget-title">Balanced</div>
                                            <div class="budget-desc">Good value for money</div>
                                        </div>
                                        <div class="budget-card" data-value="high">
                                            <div class="budget-icon">
                                                <i class="fas fa-gem"></i>
                                            </div>
                                            <div class="budget-title">Premium</div>
                                            <div class="budget-desc">Luxury experiences</div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="budget" value="medium">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" id="backToStep1" class="btn btn-back">
                                <i class="fas fa-arrow-left"></i>
                                <span>Previous</span>
                            </button>
                            <button type="button" id="nextToStep3" class="btn btn-next">
                                <span>Next: Interests</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Interests -->
                <div class="step-content step-slide" id="step3" style="display: none;">
                    <div class="step-content-inner">
                        <div class="step-header-animated">
                            <div class="step-icon-large">
                                <i class="fas fa-heart"></i>
                            </div>
                            <h2 class="animated-title">What activities interest you?</h2>
                            <p class="step-description">Select the activities that interest you for your trip.</p>
                        </div>
                        
                        <div class="form-content">
                            <div class="form-section">
                                <div class="interests-grid">
                        <div class="interest-item" data-value="beach">
                            <div class="interest-icon">
                                <i class="fas fa-umbrella-beach"></i>
                            </div>
                            <div class="interest-label">Beach</div>
                        </div>
                        <div class="interest-item" data-value="city">
                            <div class="interest-icon">
                                <i class="fas fa-city"></i>
                            </div>
                            <div class="interest-label">City</div>
                        </div>
                        <div class="interest-item" data-value="nature">
                            <div class="interest-icon">
                                <i class="fas fa-mountain"></i>
                            </div>
                            <div class="interest-label">Nature</div>
                        </div>
                        <div class="interest-item" data-value="culture">
                            <div class="interest-icon">
                                <i class="fas fa-landmark"></i>
                            </div>
                            <div class="interest-label">Culture</div>
                        </div>
                        <div class="interest-item" data-value="food">
                            <div class="interest-icon">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="interest-label">Food</div>
                        </div>
                        <div class="interest-item" data-value="adventure">
                            <div class="interest-icon">
                                <i class="fas fa-hiking"></i>
                            </div>
                            <div class="interest-label">Adventure</div>
                        </div>
                        <div class="interest-item" data-value="wildlife">
                            <div class="interest-icon">
                                <i class="fas fa-paw"></i>
                            </div>
                            <div class="interest-label">Wildlife</div>
                        </div>
                        <div class="interest-item" data-value="history">
                            <div class="interest-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="interest-label">History</div>
                        </div>
                        <div class="interest-item" data-value="shopping">
                            <div class="interest-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="interest-label">Shopping</div>
                        </div>
                        <div class="interest-item" data-value="nightlife">
                            <div class="interest-icon">
                                <i class="fas fa-cocktail"></i>
                            </div>
                            <div class="interest-label">Nightlife</div>
                        </div>
                        <div class="interest-item" data-value="relaxation">
                            <div class="interest-icon">
                                <i class="fas fa-spa"></i>
                            </div>
                            <div class="interest-label">Relaxation</div>
                        </div>
                        <div class="interest-item" data-value="photography">
                            <div class="interest-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="interest-label">Photography</div>
                        </div>
                        <div class="interest-item" data-value="art">
                            <div class="interest-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="interest-label">Art</div>
                        </div>
                        <div class="interest-item" data-value="architecture">
                            <div class="interest-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="interest-label">Architecture</div>
                        </div>
                        <div class="interest-item" data-value="water-sports">
                            <div class="interest-icon">
                                <i class="fas fa-water"></i>
                            </div>
                            <div class="interest-label">Water Sports</div>
                        </div>
                        <div class="interest-item" data-value="local-experiences">
                            <div class="interest-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="interest-label">Local Experiences</div>
                        </div>
                    </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-group">
                                    <label for="custom-interest" class="form-label">
                                        <i class="fas fa-plus-circle"></i> Add your own interest:
                                    </label>
                                    <div class="custom-interest-input">
                                        <div class="input-wrapper">
                                            <input type="text" id="custom-interest" class="enhanced-input" placeholder="Enter your interest">
                                            <div class="input-icon"><i class="fas fa-plus"></i></div>
                                        </div>
                                        <button type="button" id="add-custom-interest" class="btn btn-sm">Add</button>
                                    </div>
                                    <div id="custom-interests-container" class="custom-interests-container"></div>
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="interests" value="">
                        
                        <div class="form-buttons">
                            <button type="button" id="backToStep2" class="btn btn-back">
                                <i class="fas fa-arrow-left"></i>
                                <span>Previous</span>
                            </button>
                            <button type="button" id="nextToStep4" class="btn btn-next">
                                <span>Next: Review</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Review -->
                <div class="step-content step-slide" id="step4" style="display: none;">
                    <div class="step-content-inner">
                        <div class="step-header-animated">
                            <div class="step-icon-large">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h2 class="animated-title">Review Your Trip Details</h2>
                            <p class="step-description">Please review your trip details before generating your itinerary.</p>
                        </div>
                        
                        <div class="form-content">
                            <div class="form-section">
                                <div class="review-details">
                        <div class="review-section">
                            <h3>Destination</h3>
                            <div class="review-item">
                                <span class="review-label">Destination:</span>
                                <span id="review-destination" class="review-value">Loading...</span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Start City:</span>
                                <span id="review-start-city" class="review-value">Loading...</span>
                            </div>
                        </div>
                        
                        <div class="review-section">
                            <h3>Trip Details</h3>
                            <div class="review-item">
                                <span class="review-label">Duration:</span>
                                <span id="review-duration" class="review-value">Loading...</span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Season:</span>
                                <span id="review-season" class="review-value">Loading...</span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Travelers:</span>
                                <span id="review-people" class="review-value">Loading...</span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Budget:</span>
                                <span id="review-budget" class="review-value">Loading...</span>
                            </div>
                        </div>
                        
                        <div class="review-section">
                            <h3>Interests</h3>
                            <div class="review-item">
                                <span id="review-interests" class="review-value">Loading...</span>
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" id="backToStep3" class="btn btn-back">
                                <i class="fas fa-arrow-left"></i>
                                <span>Previous</span>
                            </button>
                            <button type="button" id="generateButton" class="btn btn-next">
                                <span>Generate Itinerary</span>
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div id="loadingState" style="display: none;">
    <div class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Planning Your Trip</h2>
            <p>Our AI is crafting your perfect itinerary. This may take a few moments...</p>
        </div>
    </div>
</div>

<!-- Result Container -->
<div id="itineraryResult" style="display: none;">
    <div class="result-container">
        <div class="result-header">
            <div class="header-content">
                <h2 id="result-title">Your Itinerary</h2>
                <p id="result-description"></p>
                <div class="rating-display">
                    <span class="stars">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                    </span>
                    <span class="rating-value">4.5</span>
                </div>
                <span class="trip-duration"><i class="far fa-clock"></i> <span id="days-count">7</span> days</span>
            </div>
        </div>
        
        <div class="tabs-container">
            <div class="result-tabs">
                <button class="tab-btn active" data-tab="overview">Overview</button>
                <button class="tab-btn" data-tab="day-by-day">Day by Day</button>
                <button class="tab-btn" data-tab="budget">Budget</button>
            </div>
            
            <div class="itinerary-actions">
                <button class="action-btn" id="downloadBtn"><i class="fas fa-download"></i> Download</button>
            </div>
        </div>
        
        <div class="tab-content active" id="overview-tab">
            <div class="summary-section">
                <h3>Trip Summary</h3>
                <p class="summary-text">Discover the perfect balance of adventure, culture and relaxation in this tropical paradise.</p>
                
                <div class="highlights-section">
                    <h4>Highlights:</h4>
                    <div class="highlights-tags" id="highlights-container">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
            
            <div class="city-info">
                <div class="info-grid">
                    <div class="info-card">
                        <div class="card-icon"><i class="fas fa-map-marker-alt"></i></div>
                        <h3>Top Attractions</h3>
                        <ul id="attractions-list" class="info-list"></ul>
                    </div>
                    
                    <div class="info-card">
                        <div class="card-icon"><i class="fas fa-utensils"></i></div>
                        <h3>Local Cuisine</h3>
                        <ul id="cuisine-list" class="info-list"></ul>
                    </div>
                    
                    <div class="info-card">
                        <div class="card-icon"><i class="fas fa-hands"></i></div>
                        <h3>Cultural Tips</h3>
                        <ul id="cultural-list" class="info-list"></ul>
                    </div>
                    
                    <div class="info-card">
                        <div class="card-icon"><i class="fas fa-bed"></i></div>
                        <h3>Accommodation Areas</h3>
                        <ul id="accommodation-list" class="info-list"></ul>
                    </div>
                    
                    <div class="info-card">
                        <div class="card-icon"><i class="fas fa-bus"></i></div>
                        <h3>Transportation Tips</h3>
                        <ul id="transportation-list" class="info-list"></ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="day-by-day-tab">
            <div id="itinerary-container" class="itinerary-container">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        
        <div class="tab-content" id="budget-tab">
            <div class="budget-display">
                <div class="budget-summary">
                    <div class="budget-header">
                        <div class="budget-total">
                            <span class="label">Total Budget:</span>
                            <span class="currency" id="budget-currency-display">INR</span>
                            <span class="amount" id="budget-amount">0</span>
                        </div>
                        <div class="budget-level-container">
                            <span class="label">Budget Level:</span>
                            <span id="budget-level">Medium</span>
                        </div>
                    </div>
                    
                    <div class="budget-chart-container">
                        <h4>Budget Breakdown</h4>
                        <div class="budget-chart">
                            <!-- Chart bars will be inserted here by JavaScript -->
                        </div>
                    </div>
                    
                    <div id="budget-breakdown" class="budget-breakdown">
                        <!-- Budget categories will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bottom-actions">
            <form id="downloadForm" action="{{ url_for('download_pdf') }}" method="POST">
                <input type="hidden" name="plan_id" id="plan-id-input">
                <input type="hidden" name="trip_name" id="trip-name-input">
                <input type="hidden" name="trip_description" id="trip-description-input">
            </form>
            <button id="newPlanButton" class="btn btn-primary"><i class="fas fa-plus"></i> Create New Plan</button>
        </div>
    </div>
</div>

<!-- Add this right before the closing </main> tag -->
<div class="modal" id="downloadModal">
    <div class="modal-content">
        <span class="modal-close" id="closeDownloadModal">&times;</span>
        <div class="modal-header">
            <h3 class="modal-title">Download Itinerary</h3>
        </div>
        <div class="modal-body">
            <form id="pdfDetailsForm">
                <input type="hidden" id="pdf-plan-id" name="plan_id">
                <div class="form-group">
                    <label for="trip-name">Trip Name *</label>
                    <input type="text" class="form-control" id="trip-name" name="trip_name" required>
                </div>
                <div class="form-group">
                    <label for="trip-description">Trip Description (optional)</label>
                    <textarea class="form-control" id="trip-description" name="trip_description" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelDownload">Cancel</button>
            <button type="button" class="btn" id="confirmDownload">Download PDF</button>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_css %}
<style>
    .dashboard-container {
        min-height: calc(100vh - 300px);
    }
    
    .dashboard-header {
        background-color: var(--primary-color);
        color: white;
        padding: 60px 0;
        text-align: center;
    }
    
    .dashboard-header h1 {
        font-size: 2.5rem;
        margin-bottom: 15px;
    }
    
    .dashboard-header p {
        font-size: 1.2rem;
        max-width: 700px;
        margin: 0 auto;
    }
    
    .trip-builder {
        padding: 50px 0;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }
    
    .step-container {
        max-width: 900px;
        margin: 0 auto;
        background-color: #fff;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
        position: relative;
    }
    
    /* Enhanced Progress Bar */
    .progress-wrapper {
        background: linear-gradient(135deg, var(--primary-color) 0%, #3498db 100%);
        padding: 50px 30px 40px;
        position: relative;
        overflow: hidden;
    }
    
    .progress-wrapper::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        opacity: 0.3;
    }
    
    .progress-line {
        position: absolute;
        top: 90px;
        left: 80px;
        right: 80px;
        height: 3px;
        background-color: rgba(255,255,255,0.25);
        border-radius: 2px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
        border-radius: 2px;
        width: 25%;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        box-shadow: 0 0 8px rgba(255,255,255,0.3);
    }
    
    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 20px;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.9));
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-20px); opacity: 0; }
        50% { opacity: 1; }
        100% { transform: translateX(20px); opacity: 0; }
    }
    
    .steps-header {
        display: flex;
        justify-content: space-between;
        padding: 0;
        position: relative;
        z-index: 2;
        align-items: flex-start;
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
        padding: 0 10px;
        min-width: 0;
    }
    
    .step-circle {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background-color: rgba(255,255,255,0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        position: relative;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(15px);
        border: 3px solid rgba(255,255,255,0.25);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .step-number {
        font-weight: 700;
        color: rgba(255,255,255,0.9);
        font-size: 20px;
        transition: all 0.3s ease;
    }
    
    .step-icon {
        position: absolute;
        font-size: 24px;
        color: rgba(255,255,255,0.95);
        opacity: 0;
        transform: scale(0);
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .step-label {
        text-align: center;
        color: white;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .step-title {
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 6px;
        transition: all 0.3s ease;
        color: white;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .step-subtitle {
        font-size: 13px;
        opacity: 0.9;
        transition: all 0.3s ease;
        color: rgba(255,255,255,0.95);
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .step.active .step-circle {
        background: linear-gradient(135deg, #ffffff, rgba(255,255,255,0.95));
        border-color: white;
        transform: scale(1.15);
        box-shadow: 0 8px 30px rgba(0,0,0,0.2), 0 0 0 4px rgba(255,255,255,0.3);
    }
    
    .step.active .step-number {
        opacity: 0;
        transform: scale(0);
    }
    
    .step.active .step-icon {
        opacity: 1;
        transform: scale(1);
        color: var(--primary-color);
    }
    
    .step.active .step-title {
        color: white;
        font-weight: 800;
        text-shadow: 0 2px 4px rgba(0,0,0,0.4);
        transform: scale(1.05);
    }
    
    .step.active .step-subtitle {
        color: white;
        opacity: 1;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        transform: scale(1.02);
    }
    
    .step.completed .step-circle {
        background: linear-gradient(135deg, #28a745, #20c997);
        border-color: #28a745;
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4), 0 0 0 3px rgba(255,255,255,0.2);
    }
    
    .step.completed .step-number {
        opacity: 0;
        transform: scale(0);
    }
    
    .step.completed .step-icon {
        opacity: 1;
        transform: scale(1);
        color: white;
    }
    
    .step.completed .step-title {
        color: white;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    
    .step.completed .step-subtitle {
        color: white;
        opacity: 1;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .step-content {
        padding: 50px 40px;
        min-height: 500px;
        opacity: 0;
        transform: translateX(30px);
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .step-content.active {
        opacity: 1;
        transform: translateX(0);
    }
    
    .step-content-inner {
        max-width: 600px;
        margin: 0 auto;
    }
    
    .step-header-animated {
        text-align: center;
        margin-bottom: 40px;
        animation: fadeInUp 0.8s ease-out;
    }
    
    .step-icon-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        box-shadow: 0 10px 30px rgba(30, 115, 190, 0.3);
        animation: pulse 2s infinite;
    }
    
    .step-icon-large i {
        font-size: 32px;
        color: white;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 10px 30px rgba(30, 115, 190, 0.3); }
        50% { box-shadow: 0 15px 40px rgba(30, 115, 190, 0.5); }
        100% { box-shadow: 0 10px 30px rgba(30, 115, 190, 0.3); }
    }
    
    .animated-title {
        font-size: 2.2rem;
        margin-bottom: 15px;
        color: #333;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .step-description {
        color: #666;
        margin-bottom: 25px;
        font-size: 1.1rem;
        line-height: 1.6;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .form-content {
        animation: fadeInUp 0.8s ease-out 0.2s both;
    }
    
    .form-group {
        margin-bottom: 30px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 12px;
        font-weight: 600;
        color: #333;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-label i {
        color: var(--primary-color);
        font-size: 18px;
    }
    
    .form-section {
        margin-bottom: 35px;
        padding: 25px;
        background: linear-gradient(135deg, #f8fbff 0%, #f0f7ff 100%);
        border-radius: 15px;
        border: 1px solid rgba(30, 115, 190, 0.1);
        transition: all 0.3s ease;
    }
    
    .form-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(30, 115, 190, 0.1);
    }
    
    .input-wrapper {
        position: relative;
    }
    
    .enhanced-input {
        width: 100%;
        padding: 15px 50px 15px 20px;
        border: 2px solid #e1ecf4;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: white;
        font-weight: 500;
    }
    
    .enhanced-input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(30, 115, 190, 0.1);
        transform: translateY(-1px);
    }
    
    .enhanced-input::placeholder {
        color: #aaa;
        font-weight: 400;
    }
    
    .input-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--primary-color);
        font-size: 18px;
        pointer-events: none;
        transition: all 0.3s ease;
    }
    
    .input-wrapper:focus-within .input-icon {
        transform: translateY(-50%) scale(1.1);
    }
    
    .radio-cards {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 15px;
    }
    
    .radio-card {
        position: relative;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .radio-card input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }
    
    .radio-card label {
        display: block;
        padding: 25px 20px;
        background: white;
        border: 2px solid #e1ecf4;
        border-radius: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .radio-card label::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        opacity: 0;
        transition: all 0.4s ease;
        z-index: -1;
    }
    
    .radio-card:hover label {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(30, 115, 190, 0.15);
    }
    
    .radio-card input[type="radio"]:checked + label {
        border-color: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(30, 115, 190, 0.3);
    }
    
    .radio-card input[type="radio"]:checked + label::before {
        left: 0;
        opacity: 1;
    }
    
    .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        transition: all 0.3s ease;
    }
    
    .card-icon i {
        font-size: 22px;
        color: white;
    }
    
    .radio-card input[type="radio"]:checked + label .card-icon {
        background: white;
        transform: scale(1.1);
    }
    
    .radio-card input[type="radio"]:checked + label .card-icon i {
        color: var(--primary-color);
    }
    
    .card-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #333;
        transition: all 0.3s ease;
    }
    
    .radio-card input[type="radio"]:checked + label .card-title {
        color: white;
    }
    
    .card-desc {
        font-size: 14px;
        color: #666;
        transition: all 0.3s ease;
    }
    
    .radio-card input[type="radio"]:checked + label .card-desc {
        color: rgba(255,255,255,0.9);
    }
    
    .budget-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-top: 15px;
    }
    
    .budget-card {
        background: white;
        border: 2px solid #e1ecf4;
        border-radius: 15px;
        padding: 25px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .budget-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        opacity: 0;
        transition: all 0.4s ease;
        z-index: -1;
    }
    
    .budget-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(30, 115, 190, 0.2);
    }
    
    .budget-card.selected {
        border-color: var(--primary-color);
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 20px 40px rgba(30, 115, 190, 0.3);
    }
    
    .budget-card.selected::before {
        left: 0;
        opacity: 1;
    }
    
    .budget-card .budget-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        transition: all 0.3s ease;
    }
    
    .budget-card .budget-icon i {
        font-size: 22px;
        color: white;
    }
    
    .budget-card.selected .budget-icon {
        background: white;
        transform: scale(1.1);
    }
    
    .budget-card.selected .budget-icon i {
        color: var(--primary-color);
    }
    
    .budget-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #333;
        transition: all 0.3s ease;
    }
    
    .budget-card.selected .budget-title {
        color: white;
    }
    
    .budget-desc {
        font-size: 14px;
        color: #666;
        transition: all 0.3s ease;
    }
    
    .budget-card.selected .budget-desc {
        color: rgba(255,255,255,0.9);
    }
    
    .form-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid rgba(30, 115, 190, 0.1);
    }
    
    .btn {
        padding: 15px 35px;
        border: none;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 180px;
        justify-content: center;
    }
    
    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .btn:hover::before {
        left: 100%;
    }
    
    .btn-next {
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        color: white;
        box-shadow: 0 8px 25px rgba(30, 115, 190, 0.3);
    }
    
    .btn-next:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(30, 115, 190, 0.4);
    }
    
    .btn-next:active {
        transform: translateY(-1px);
    }
    
    .btn-back {
        background: #f8f9fa;
        color: #666;
        border: 2px solid #e9ecef;
    }
    
    .btn-back:hover {
        background: #e9ecef;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .btn i {
        transition: transform 0.3s ease;
    }
    
    .btn-next:hover i {
        transform: translateX(3px);
    }
    
    .btn-back:hover i {
        transform: translateX(-3px);
    }
    
    .interests-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .interest-item {
        background: white;
        border: 2px solid #e1ecf4;
        border-radius: 15px;
        padding: 20px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .interest-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        opacity: 0;
        transition: all 0.4s ease;
        z-index: -1;
    }
    
    .interest-item:hover {
        border-color: var(--primary-color);
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(30, 115, 190, 0.15);
    }
    
    .interest-item.selected {
        border-color: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(30, 115, 190, 0.3);
    }
    
    .interest-item.selected::before {
        left: 0;
        opacity: 1;
    }
    
    .interest-icon {
        font-size: 1.8rem;
        margin-bottom: 12px;
        color: #555;
        transition: all 0.3s ease;
    }
    
    .interest-item.selected .interest-icon {
        color: white;
        transform: scale(1.1);
    }
    
    .interest-label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .interest-item.selected .interest-label {
        color: white;
    }
    
    .custom-interest-input {
        display: flex;
        gap: 15px;
        align-items: flex-end;
    }
    
    .custom-interest-input .input-wrapper {
        flex: 1;
    }
    
    .custom-interest-input .btn-sm {
        padding: 12px 20px;
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .custom-interest-input .btn-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(30, 115, 190, 0.3);
    }
    
    .custom-interests-container {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 20px;
    }
    
    .custom-interest {
        background: linear-gradient(135deg, #f0f7ff, #e8f4fd);
        border: 1px solid #c7e0ff;
        border-radius: 25px;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--primary-color);
        transition: all 0.3s ease;
    }
    
    .custom-interest:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 115, 190, 0.2);
    }
    
    .interest-text {
        margin-right: 10px;
    }
    
    .remove-interest {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        font-size: 0.8rem;
        padding: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        transition: all 0.3s ease;
    }
    
    .remove-interest:hover {
        color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
        transform: scale(1.2);
    }
    
    .review-details {
        background: linear-gradient(135deg, #f8fbff 0%, #f0f7ff 100%);
        border: 1px solid rgba(30, 115, 190, 0.1);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    .review-details:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(30, 115, 190, 0.1);
    }
    
    .review-section {
        margin-bottom: 30px;
    }
    
    .review-section:last-child {
        margin-bottom: 0;
    }
    
    .review-section h3 {
        font-size: 1.3rem;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid rgba(30, 115, 190, 0.2);
        color: var(--primary-color);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .review-section h3::before {
        content: '';
        width: 4px;
        height: 20px;
        background: linear-gradient(135deg, var(--primary-color), #3498db);
        border-radius: 2px;
    }
    
    .review-item {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        padding: 12px 0;
        border-bottom: 1px dashed rgba(30, 115, 190, 0.1);
    }
    
    .review-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .review-label {
        min-width: 140px;
        font-weight: 600;
        color: #555;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .review-label::before {
        content: '•';
        color: var(--primary-color);
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .review-value {
        flex: 1;
        color: #333;
        font-weight: 500;
        font-size: 1rem;
        padding-left: 15px;
        line-height: 1.4;
    }
    
    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .loading-content {
        text-align: center;
        max-width: 400px;
        padding: 30px;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        margin: 0 auto 20px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Results display */
    .result-container {
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 50px;
        overflow: hidden;
    }

    .result-header {
        padding: 60px 30px;
        background-color: #073566;
        background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1571893544028-06b07af6dade');
        background-size: cover;
        background-position: center;
        color: white;
        position: relative;
    }

    .header-content {
        position: relative;
        z-index: 2;
    }

    .result-header h2 {
        font-size: 2.5rem;
        font-weight: 500;
        color: white;
        margin-bottom: 15px;
    }

    .result-header p {
        font-size: 1.2rem;
        color: rgba(255,255,255,0.9);
        margin-bottom: 15px;
    }
    
    .rating-display {
        display: flex;
        align-items: center;
        margin-top: 15px;
    }
    
    .stars {
        color: #FFD700;
        margin-right: 8px;
    }
    
    .rating-value {
        font-weight: 500;
    }
    
    .trip-duration {
        display: inline-flex;
        align-items: center;
        background: rgba(255,255,255,0.2);
        padding: 5px 12px;
        border-radius: 20px;
        margin-left: 15px;
        font-size: 0.9rem;
    }
    
    .trip-duration i {
        margin-right: 5px;
    }
    
    .tabs-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding: 0 20px;
        background-color: white;
    }

    .result-tabs {
        display: flex;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .result-tabs::-webkit-scrollbar {
        display: none;
    }

    .tab-btn {
        padding: 20px 25px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: var(--transition);
        color: #666;
        font-size: 15px;
        white-space: nowrap;
    }

    .tab-btn.active {
        color: var(--primary-color);
        border-bottom: 3px solid var(--primary-color);
    }
    
    .itinerary-actions {
        display: flex;
        gap: 10px;
    }
    
    .action-btn {
        padding: 8px 16px;
        background: none;
        border: 1px solid #ddd;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: var(--transition);
    }
    
    .action-btn:hover {
        background-color: #f5f5f5;
    }

    .tab-content {
        display: none;
        padding: 40px 30px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .tab-content.active {
        display: block;
        opacity: 1;
    }
    
    /* Summary section styles */
    .summary-section {
        margin-bottom: 40px;
    }
    
    .summary-section h3 {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: var(--primary-color);
    }
    
    .summary-text {
        font-size: 16px;
        line-height: 1.6;
        color: #555;
        margin-bottom: 20px;
    }
    
    .highlights-section {
        margin-top: 20px;
    }
    
    .highlights-section h4 {
        font-size: 16px;
        margin-bottom: 10px;
        color: #444;
    }
    
    .highlights-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .highlight-tag {
        background-color: #f0f7ff;
        color: var(--primary-color);
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 14px;
        display: inline-block;
    }

    /* Info cards styles */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
    }
    
    .info-card {
        background-color: #f0f7ff;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .info-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }
    
    .card-icon {
        background-color: #e0ebfa;
        color: var(--primary-color);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 15px;
        font-size: 22px;
    }
    
    .info-card h3 {
        font-size: 18px;
        margin-bottom: 15px;
        color: var(--primary-color);
    }
    
    .info-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    
    .info-list li {
        padding: 10px 0;
        border-bottom: 1px dashed #e0e0e0;
        line-height: 1.5;
        font-size: 15px;
        color: #555;
    }
    
    .info-list li:last-child {
        border-bottom: none;
    }
    
    /* Itinerary timeline styles */
    .itinerary-container {
        position: relative;
        padding-left: 30px;
    }
    
    .itinerary-container:before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #1e73be;
        background-image: linear-gradient(#1e73be, #3498db, #1e73be);
    }
    
    .day-container {
        margin-bottom: 50px;
        position: relative;
    }
    
    .day-container:last-child {
        margin-bottom: 0;
    }
    
    .day-header {
        margin-bottom: 25px;
        position: relative;
    }
    
    .day-header:before {
        content: "";
        position: absolute;
        left: -36px;
        top: 5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #1e73be;
        border: 4px solid white;
        box-shadow: 0 0 0 2px #1e73be, 0 0 10px rgba(0,0,0,0.3);
        z-index: 1;
    }
    
    .day-header h3 {
        font-size: 24px;
        color: #1e73be;
        margin: 0;
        padding: 5px 0;
        font-weight: 600;
        border-bottom: 2px solid #e0f0ff;
        display: inline-block;
    }
    
    .activity-item {
        background-color: white;
        border-radius: 10px;
        padding: 22px 25px;
        margin-bottom: 20px;
        display: flex;
        box-shadow: 0 3px 12px rgba(0,0,0,0.08);
        border: 1px solid #e9f3ff;
        transition: all 0.3s ease;
    }
    
    .activity-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        border-color: #c7e0ff;
    }
    
    .activity-time {
        min-width: 90px;
        font-weight: 600;
        color: #1e73be;
        font-size: 16px;
        padding-right: 15px;
        border-right: 2px dashed #e0f0ff;
        display: flex;
        align-items: center;
    }
    
    .activity-details {
        flex: 1;
        padding-left: 20px;
    }
    
    .activity-name {
        font-weight: 600;
        font-size: 18px;
        color: #333;
        margin-bottom: 8px;
    }
    
    .activity-location {
        color: #666;
        font-size: 15px;
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .activity-location:before {
        content: '\f3c5';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        margin-right: 8px;
        font-size: 14px;
        color: #f39c12;
    }
    
    .activity-transport {
        color: #777;
        font-size: 14px;
        display: flex;
        align-items: center;
        background-color: #f8fcff;
        border-radius: 30px;
        padding: 5px 12px;
        margin-top: 5px;
        display: inline-flex;
    }
    
    .activity-transport i {
        margin-right: 8px;
        color: #1e73be;
    }
    
    /* Map view placeholder */
    .map-placeholder {
        background-color: #f9f9f9;
        border-radius: 8px;
        height: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #888;
    }
    
    .map-placeholder i {
        font-size: 60px;
        margin-bottom: 20px;
        color: #ccc;
    }
    
    /* Budget styles */
    .budget-display {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
    }
    
    .budget-summary {
        background-color: #f7f9fc;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        position: relative;
        border: 1px solid #e6f0ff;
    }
    
    .budget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e6f0ff;
    }
    
    .budget-header h3 {
        margin: 0;
        font-size: 20px;
        color: #1e73be;
        font-weight: 600;
    }
    
    .budget-level {
        background-color: #1e73be;
        color: white;
        padding: 6px 14px;
        border-radius: 30px;
        font-size: 13px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .budget-total {
        text-align: center;
        padding: 25px 0;
        margin: 15px 0 25px;
        background-color: #e9f3ff;
        border-radius: 8px;
        border-left: 5px solid #1e73be;
    }
    
    .budget-total .currency {
        font-size: 18px;
        color: #666;
        margin-right: 5px;
        font-weight: 500;
    }
    
    .budget-total .amount {
        font-size: 36px;
        font-weight: 700;
        color: #1e73be;
    }
    
    .budget-note {
        font-size: 13px;
        color: #888;
        text-align: center;
        margin-top: 15px;
        font-style: italic;
    }
    
    .budget-breakdown {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .budget-category {
        background-color: white;
        border-radius: 10px;
        padding: 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border: 1px solid #eef4f8;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .budget-category:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .budget-category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        font-weight: 600;
        border-bottom: 1px solid #f5f5f5;
        background-color: #f9fbfd;
    }
    
    .budget-category-header i {
        margin-right: 10px;
        color: #1e73be;
        font-size: 16px;
    }
    
    /* Different colors for different categories */
    .budget-category.accommodation .budget-category-header {
        border-left: 4px solid #3498db;
    }
    
    .budget-category.transportation .budget-category-header {
        border-left: 4px solid #2ecc71;
    }
    
    .budget-category.activities .budget-category-header {
        border-left: 4px solid #9b59b6;
    }
    
    .budget-category.meals .budget-category-header {
        border-left: 4px solid #e74c3c;
    }
    
    .budget-category.emergency_fund .budget-category-header {
        border-left: 4px solid #f39c12;
    }
    
    .budget-category.travel .budget-category-header {
        border-left: 4px solid #1abc9c;
    }
    
    /* Category cost pills */
    .budget-category-header .cost-pill {
        background-color: #1e73be;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }
    
    .budget-category.accommodation .budget-category-header .cost-pill {
        background-color: #3498db;
    }
    
    .budget-category.transportation .budget-category-header .cost-pill {
        background-color: #2ecc71;
    }
    
    .budget-category.activities .budget-category-header .cost-pill {
        background-color: #9b59b6;
    }
    
    .budget-category.meals .budget-category-header .cost-pill {
        background-color: #e74c3c;
    }
    
    .budget-category.emergency_fund .budget-category-header .cost-pill {
        background-color: #f39c12;
    }
    
    .budget-category.travel .budget-category-header .cost-pill {
        background-color: #1abc9c;
    }
    
    .budget-category-content {
        color: #666;
        font-size: 14px;
        line-height: 1.6;
        padding: 15px 20px;
    }

    /* Bottom actions */
    .bottom-actions {
        display: flex;
        justify-content: center;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid #eee;
    }
    
    .bottom-actions .btn-primary {
        background-color: var(--primary-color);
        color: white;
        padding: 12px 24px;
        border-radius: 30px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .bottom-actions .btn-primary:hover {
        background-color: #062d52;
    }
    
    /* Responsive styles */
    @media (max-width: 992px) {
        .budget-display {
            grid-template-columns: 1fr;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        /* Progress bar responsive adjustments */
        .progress-wrapper {
            padding: 40px 20px 30px;
        }
        
        .progress-line {
            left: 60px;
            right: 60px;
        }
        
        .step-circle {
            width: 65px;
            height: 65px;
        }
        
        .step-title {
            font-size: 14px;
        }
        
        .step-subtitle {
            font-size: 12px;
        }
    }
    
    @media (max-width: 768px) {
        .tabs-container {
            flex-direction: column;
            align-items: stretch;
        }
        
        .itinerary-actions {
            justify-content: center;
            padding: 10px 0;
            border-top: 1px solid #eee;
        }
        
        .result-header {
            padding: 40px 20px;
        }
        
        .result-header h2 {
            font-size: 2rem;
        }
        
        .tab-content {
            padding: 30px 20px;
        }
        
        .activity-item {
            flex-direction: column;
        }
        
        .activity-time {
            margin-bottom: 10px;
        }
        
        /* Mobile progress bar adjustments */
        .progress-wrapper {
            padding: 30px 15px 25px;
        }
        
        .progress-line {
            left: 45px;
            right: 45px;
            top: 85px;
        }
        
        .step {
            padding: 0 8px;
        }
        
        .step-circle {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
        }
        
        .step-number {
            font-size: 18px;
        }
        
        .step-icon {
            font-size: 20px;
        }
        
        .step-title {
            font-size: 13px;
        }
        
        .step-subtitle {
            font-size: 11px;
        }
        
        .step.active .step-circle {
            transform: scale(1.1);
        }
        
        .step.completed .step-circle {
            transform: scale(1.05);
        }
    }
    
    @media (max-width: 480px) {
        .progress-wrapper {
            padding: 25px 10px 20px;
        }
        
        .progress-line {
            left: 35px;
            right: 35px;
            top: 80px;
            height: 2px;
        }
        
        .step {
            padding: 0 5px;
        }
        
        .step-circle {
            width: 55px;
            height: 55px;
            border-width: 2px;
        }
        
        .step-title {
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .step-subtitle {
            font-size: 10px;
        }
        
        .step.active .step-circle,
        .step.completed .step-circle {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        /* Interests grid mobile adjustments */
        .interests-grid {
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 15px;
        }
        
        .interest-item {
            padding: 15px 10px;
        }
        
        .interest-icon {
            font-size: 1.6rem;
            margin-bottom: 10px;
        }
        
        .interest-label {
            font-size: 0.8rem;
        }
        
        .custom-interest-input {
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }
        
        .custom-interest-input .btn-sm {
            align-self: flex-start;
            padding: 10px 15px;
        }
        
        .review-details {
            padding: 20px;
        }
        
        .review-section h3 {
            font-size: 1.2rem;
        }
        
        .review-item {
            flex-direction: column;
            gap: 5px;
        }
        
        .review-label {
            min-width: auto;
        }
        
        .review-value {
            padding-left: 0;
        }
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow: auto;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: white;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        animation: modalOpen 0.3s ease-out;
        position: relative;
        margin: 10% auto;
    }

    @keyframes modalOpen {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header, .modal-body, .modal-footer {
        padding: 15px 20px;
    }

    .modal-header {
        border-bottom: 1px solid #e9e9e9;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .modal-title {
        margin: 0;
        font-size: 1.25rem;
    }

    .modal-close {
        cursor: pointer;
        font-size: 1.5rem;
        position: absolute;
        right: 15px;
        top: 10px;
    }

    .modal-footer {
        border-top: 1px solid #e9e9e9;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    #pdfDetailsForm .form-group {
        margin-bottom: 15px;
    }

    #pdfDetailsForm label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    #pdfDetailsForm input,
    #pdfDetailsForm textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #pdfDetailsForm textarea {
        resize: vertical;
    }

    /* Budget chart styles */
    .budget-chart-container {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px dashed #e6f0ff;
    }
    
    .budget-chart-container h4 {
        color: #1e73be;
        font-size: 16px;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    .budget-chart {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .chart-bar {
        position: relative;
        height: 40px;
        border-radius: 20px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        padding-left: 15px;
        transition: all 0.3s ease-in-out;
        min-width: 5%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .chart-bar:hover {
        transform: scaleX(1.02);
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    
    .chart-label {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        z-index: 2;
    }

    .chart-value {
        position: absolute;
        right: 15px;
        font-weight: 600;
    }

    /* Responsive styles */
    @media (max-width: 992px) {
        .info-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Empty itinerary message */
    .no-itinerary-message {
        text-align: center;
        padding: 40px 20px;
        background-color: #f8fcff;
        border-radius: 10px;
        border: 1px dashed #c7e0ff;
        margin: 20px 0;
    }
    
    .no-itinerary-message i {
        font-size: 48px;
        color: #c7e0ff;
        margin-bottom: 15px;
    }
    
    .no-itinerary-message p {
        font-size: 16px;
        color: #666;
    }

    /* Info Cards for Overview */
    .info-section {
        margin-bottom: 30px;
    }

    .info-card {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 20px;
        height: 100%;
        transition: all 0.3s ease;
    }

    .info-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .info-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #f0f4f9;
        padding-bottom: 10px;
    }

    .info-card-header .material-icons {
        color: #1e73be;
        margin-right: 10px;
        font-size: 24px;
    }

    .info-card-header h4 {
        margin: 0;
        color: #333;
        font-size: 16px;
        font-weight: 600;
    }

    .info-card-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .info-item {
        font-size: 14px;
        color: #555;
        padding: 6px 0;
        border-bottom: 1px dotted #eee;
    }

    .info-item:last-child {
        border-bottom: none;
    }

    /* Budget Table Styles */
    .cost-table {
        margin-top: 30px;
    }

    .cost-table h4 {
        color: #1e73be;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 600;
    }

    .cost-table table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .cost-table th {
        background-color: #f5f9ff;
        color: #333;
        font-weight: 600;
        text-align: left;
        padding: 12px;
        border-bottom: 2px solid #e6f0ff;
    }

    .cost-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
        color: #555;
    }

    .cost-table tr:hover td {
        background-color: #f9fbff;
    }

    .cost-table .total-row td {
        background-color: #f5f9ff;
        border-top: 2px solid #e6f0ff;
        border-bottom: none;
        color: #333;
    }

    /* Budget Summary Styles */
    .budget-summary {
        background-color: #f5f9ff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .budget-summary h3 {
        margin-top: 0;
        color: #333;
        font-size: 18px;
        margin-bottom: 15px;
    }

    .budget-summary h3 span {
        color: #1e73be;
        font-weight: 700;
    }

    .budget-summary p {
        margin: 10px 0;
        font-size: 14px;
        color: #555;
    }

    .budget-summary p span {
        font-weight: 600;
        color: #333;
    }

    /* Add these CSS styles in the <style> section */
    .action-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }

    .btn-secondary {
        background-color: #555;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background-color: #444;
        transform: translateY(-2px);
    }

    /* Style for the plan selector modal */
    #planSelectorModal .modal-content {
        max-width: 800px;
        width: 90%;
    }

    .test-plans-section {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px dashed #ccc;
    }
    
    .test-plans-section h3 {
        font-size: 16px;
        margin-bottom: 5px;
    }
    
    .test-plans-section p {
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .test-plans-buttons {
        display: flex;
        gap: 10px;
    }
    
    .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
    }
    
    /* Notification styles */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        font-size: 14px;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }
    
    .notification-success {
        background-color: #28a745;
        border-left: 4px solid #1e7e34;
    }
    
    .notification-error {
        background-color: #dc3545;
        border-left: 4px solid #c82333;
    }
    
    .notification-warning {
        background-color: #ffc107;
        color: #212529;
        border-left: 4px solid #e0a800;
    }
    
    .notification-info {
        background-color: #17a2b8;
        border-left: 4px solid #138496;
    }
    
    .notification-close {
        background: none;
        border: none;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        margin-left: 8px;
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    
    .notification-close:hover {
        opacity: 1;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Enhanced action buttons */
    .action-buttons {
        margin-top: 20px;
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
    }
    
    .btn-secondary:hover {
        background-color: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
    }
    
    .btn-secondary:active {
        transform: translateY(0);
    }
    
    /* Responsive adjustments for action buttons */
    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .btn-secondary {
            width: 200px;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize user session
        initializeUser();
        
        // Initialize form elements
        initializeForm();
        
        // Initialize the interest item selection immediately
        initializeInterestSelection();
        
        // Add direct debug checks for interest clicks
        debugInterestSelection();
        
        // Check if user is logged in before checking API key
        // We can detect this by checking if the apiKeyModal exists (it's only rendered for logged-in users)
        if (document.getElementById('apiKeyModal')) {
            // User is logged in, check API key
            checkAPIKey();
        }
        
        // Initialize download modal
        initializeDownloadModal();
        
    });
    
    // A direct debug function to check interest selection
    function debugInterestSelection() {
        console.log('DEBUG: Setting up direct interest click handlers');
        
        // Get all interest items
        const items = document.querySelectorAll('.interest-item');
        const hiddenInput = document.getElementById('interests');
        
        console.log(`DEBUG: Found ${items.length} interest items and input field exists: ${!!hiddenInput}`);
        
        // Try direct event listeners without fancy effects
        items.forEach(item => {
            // Add a direct click handler
            item.onclick = function(e) {
                console.log('DEBUG: Interest clicked via direct handler', this.dataset.value);
                this.classList.toggle('selected');
                
                // Update the hidden input with all currently selected interests
                const selectedItems = document.querySelectorAll('.interest-item.selected');
                const values = Array.from(selectedItems).map(el => el.dataset.value);
                
                if (hiddenInput) {
                    hiddenInput.value = values.join(',');
                    console.log('DEBUG: Updated interests to:', hiddenInput.value);
                }
            };
        });
    }
    
    function initializeInterestSelection() {
        console.log('Initializing interest selection');
        
        // Select all interest items and get the hidden input
        const interestItems = document.querySelectorAll('.interest-item');
        const interestsInput = document.getElementById('interests');
        
        console.log(`Found ${interestItems.length} interest items and input field exists: ${!!interestsInput}`);
        
        // Clear any selected interests first to avoid issues
        interestItems.forEach(item => {
            item.classList.remove('selected');
            
            // Remove any existing click event listeners
            item.onclick = null;
        });
        
        // Array to keep track of selected interests
        let selectedInterests = [];
        
        // Check if there are already selected interests in the hidden input
        if (interestsInput && interestsInput.value) {
            selectedInterests = interestsInput.value.split(',');
            console.log('Pre-existing interests:', selectedInterests);
            
            // Highlight pre-selected interests
            selectedInterests.forEach(interest => {
                const element = document.querySelector(`.interest-item[data-value="${interest}"]`);
                if (element) {
                    element.classList.add('selected');
                    console.log('Pre-selected:', interest);
                }
            });
        }
        
        // Add click events to each interest item
        interestItems.forEach(item => {
            // Set up a direct onclick handler instead of addEventListener
            item.onclick = function() {
                const value = this.getAttribute('data-value');
                console.log('Interest clicked:', value);
                
                // Toggle selected class
                this.classList.toggle('selected');
                
                // Update the selected interests array
                if (this.classList.contains('selected')) {
                    if (!selectedInterests.includes(value)) {
                        selectedInterests.push(value);
                        console.log('Added interest:', value);
                    }
                } else {
                    selectedInterests = selectedInterests.filter(interest => interest !== value);
                    console.log('Removed interest:', value);
                }
                
                // Update hidden input value
                if (interestsInput) {
                    interestsInput.value = selectedInterests.join(',');
                    console.log('Updated interests input value:', interestsInput.value);
                }
            };
        });
    }
    
    function initializeForm() {
        // Enhanced navigation with animations and progress bar
        function goToStep(stepNumber) {
            const currentStep = document.querySelector('.step-content.active');
            const nextStep = document.getElementById('step' + stepNumber);
            
            // Animate out current step
            if (currentStep) {
                currentStep.classList.remove('active');
                setTimeout(() => {
                    currentStep.style.display = 'none';
                }, 300);
            }
            
            // Show and animate in next step
            setTimeout(() => {
                // Hide all steps first
                document.querySelectorAll('.step-content').forEach(function(stepContent) {
                    stepContent.style.display = 'none';
                    stepContent.classList.remove('active');
                });
                
                // Show the selected step
                nextStep.style.display = 'block';
                
                // Trigger animation
                setTimeout(() => {
                    nextStep.classList.add('active');
                }, 50);
                
            }, currentStep ? 300 : 0);
            
            // Update step indicators with animation
            document.querySelectorAll('.step').forEach(function(step) {
                step.classList.remove('active');
                step.classList.remove('completed');
                
                const stepDataNumber = parseInt(step.getAttribute('data-step'));
                if (stepDataNumber < stepNumber) {
                    step.classList.add('completed');
                } else if (stepDataNumber === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            // Update progress bar
            updateProgressBar(stepNumber);
        }
        
        function updateProgressBar(stepNumber) {
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = (stepNumber / 4) * 100;
            
            if (progressFill) {
                progressFill.style.width = progressPercentage + '%';
            }
        }

        // Handle destination type selection
        const destinationTypeRadios = document.querySelectorAll('input[name="destination-type"]');
        const specificDestinationForm = document.getElementById('specific-destination-form');
        
        destinationTypeRadios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                if (radio.value === 'specific') {
                    specificDestinationForm.style.display = 'block';
                } else {
                    specificDestinationForm.style.display = 'none';
                }
            });
        });

        // Handle budget selection with enhanced animations
        const budgetCards = document.querySelectorAll('.budget-card');
        const budgetInput = document.getElementById('budget');
        
        budgetCards.forEach(function(card) {
            card.addEventListener('click', function() {
                // Remove selected class from all cards
                budgetCards.forEach(function(c) {
                    c.classList.remove('selected');
                });
                
                // Add selected class to clicked card
                card.classList.add('selected');
                
                // Update hidden input value
                budgetInput.value = card.getAttribute('data-value');
                
                // Add a subtle animation feedback
                card.style.transform = 'translateY(-3px) scale(1.02)';
                setTimeout(() => {
                    card.style.transform = 'translateY(-3px) scale(1)';
                }, 150);
            });
        });

        // Handle custom interest addition
        document.getElementById('add-custom-interest').addEventListener('click', function() {
            const customInterestInput = document.getElementById('custom-interest');
            const interestValue = customInterestInput.value.trim();
            
            if (interestValue) {
                addCustomInterest(interestValue);
                customInterestInput.value = '';
            }
        });
        
        // Allow pressing Enter to add custom interest
        document.getElementById('custom-interest').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('add-custom-interest').click();
            }
        });

        // Update navigation button event listeners
        document.getElementById('nextToStep2').addEventListener('click', function() {
            goToStep(2);
        });
        
        document.getElementById('backToStep1').addEventListener('click', function() {
            goToStep(1);
        });
        
        document.getElementById('nextToStep3').addEventListener('click', function() {
            goToStep(3);
        });
        
        document.getElementById('backToStep2').addEventListener('click', function() {
            goToStep(2);
        });
        
        document.getElementById('nextToStep4').addEventListener('click', function() {
            // Update review page
            updateReviewPage();
            goToStep(4);
        });
        
        document.getElementById('backToStep3').addEventListener('click', function() {
            goToStep(3);
        });
        
        // Initialize first step as active
        setTimeout(() => {
            const firstStep = document.getElementById('step1');
            if (firstStep) {
                firstStep.style.display = 'block';
                firstStep.classList.add('active');
            }
            updateProgressBar(1);
        }, 100);

        // Generate button
        document.getElementById('generateButton').addEventListener('click', function() {
            if (validateCurrentStep()) {
                // Show loading - Fix the incorrect element ID
                document.getElementById('loadingState').style.display = 'block';
                generatePlan();
            }
        });

        // Download PDF
        document.getElementById('download-pdf').addEventListener('click', function() {
            const formData = {
                plan_id: document.getElementById('plan-id-input').value
            };
            
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/download_pdf';
            form.style.display = 'none';
            
            for (const key in formData) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = formData[key];
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        });
    }

    function validateCurrentStep() {
        console.log('Validating current step...');
        
        // For step 4 (Review), we need to validate all the previous steps
        
        // Check destination type selection
        const destinationTypeRadio = document.querySelector('input[name="destination-type"]:checked');
        if (!destinationTypeRadio) {
            alert('Please select a destination type');
            return false;
        }
        
        const destinationType = destinationTypeRadio.value;
        console.log('Destination type:', destinationType);
        
        if (destinationType === 'specific') {
            const selectedCityElement = document.getElementById('selected-city');
            const selectedCity = selectedCityElement ? selectedCityElement.value.trim() : '';
            console.log('Selected city:', selectedCity);
            
            if (!selectedCity) {
                alert('Please enter a destination city');
                return false;
            }
        }
        
        // Check start city (required for all trips)
        const startCityElement = document.getElementById('start-city');
        const startCity = startCityElement ? startCityElement.value.trim() : '';
        console.log('Start city:', startCity);
        
        if (!startCity) {
            alert('Please enter your starting city');
            return false;
        }
        
        // Check duration
        const durationElement = document.getElementById('duration');
        const duration = durationElement ? durationElement.value : '';
        console.log('Duration:', duration);
        
        if (!duration || parseInt(duration) < 1) {
            alert('Please enter a valid trip duration');
            return false;
        }
        
        // Check season
        const seasonElement = document.getElementById('season');
        const season = seasonElement ? seasonElement.value : '';
        console.log('Season:', season);
        
        if (!season) {
            alert('Please select a season for your trip');
            return false;
        }
        
        // Check interests (optional but recommended)
        const selectedInterests = getSelectedInterests();
        console.log('Selected interests:', selectedInterests);
        
        if (selectedInterests.length === 0) {
            const proceed = confirm('You haven\'t selected any interests. Would you like to proceed anyway?');
            if (!proceed) {
                return false;
            }
        }
        
        console.log('Validation passed!');
        return true;
    }

    function addCustomInterest(interestValue) {
        // Create custom interest element
        const customInterestsContainer = document.getElementById('custom-interests-container');
        const interestElement = document.createElement('div');
        interestElement.className = 'custom-interest';
        
        // Create the interest tag with delete button
        interestElement.innerHTML = `
            <span class="interest-text">${interestValue}</span>
            <button type="button" class="remove-interest"><i class="fas fa-times"></i></button>
        `;
        
        // Add event listener to remove button
        interestElement.querySelector('.remove-interest').addEventListener('click', function() {
            customInterestsContainer.removeChild(interestElement);
        });
        
        // Add to container
        customInterestsContainer.appendChild(interestElement);
    }

    function getSelectedInterests() {
        console.log('Getting selected interests');
        const selectedInterests = [];
        
        // Get selected grid interests
        const selectedItems = document.querySelectorAll('.interest-item.selected');
        console.log(`Found ${selectedItems.length} selected interest items`);
        
        selectedItems.forEach(function(interestItem) {
            // Get the interest value from the data-value attribute
            const interestValue = interestItem.getAttribute('data-value');
            if (interestValue) {
                console.log(`Adding interest: ${interestValue}`);
                selectedInterests.push(interestValue);
            }
        });
        
        // Get custom interests
        const customItems = document.querySelectorAll('.custom-interest .interest-text');
        console.log(`Found ${customItems.length} custom interests`);
        
        customItems.forEach(function(interestText) {
            const customInterest = interestText.textContent.trim();
            if (customInterest) {
                console.log(`Adding custom interest: ${customInterest}`);
                selectedInterests.push(customInterest);
            }
        });
        
        // Also check the hidden input field in case it has a value
        const interestsInput = document.getElementById('interests');
        if (interestsInput && interestsInput.value) {
            const hiddenInterests = interestsInput.value.split(',').map(s => s.trim()).filter(s => s.length > 0);
            console.log('Interests from hidden input:', hiddenInterests);
            
            // Add any interests from hidden input that aren't already in the array
            hiddenInterests.forEach(interest => {
                if (!selectedInterests.includes(interest)) {
                    selectedInterests.push(interest);
                }
            });
        }
        
        // Update the hidden input value
        if (interestsInput) {
            interestsInput.value = selectedInterests.join(',');
            console.log('Updated interests input value to:', interestsInput.value);
        }
        
        console.log('Final interests array:', selectedInterests);
        return selectedInterests;
    }

    function updateReviewPage() {
        console.log('Updating review page');
        
        // Debug: Check if elements exist
        console.log('Review Page Element Check:');
        console.log('Destination type radio:', document.querySelector('input[name="destination-type"]:checked'));
        console.log('Selected city element:', document.getElementById('selected-city'));
        console.log('Start city element:', document.getElementById('start-city'));
        console.log('Duration element:', document.getElementById('duration'));
        console.log('Season element:', document.getElementById('season'));
        console.log('People element:', document.getElementById('people'));
        console.log('Budget element:', document.getElementById('budget'));
        console.log('Budget currency element:', document.getElementById('budget-currency'));
        
        // Get form values with enhanced error checking
        const destinationTypeRadio = document.querySelector('input[name="destination-type"]:checked');
        if (!destinationTypeRadio) {
            console.error('No destination type selected');
            return;
        }
        
        const destinationType = destinationTypeRadio.value;
        let destination = '';
        
        if (destinationType === 'specific') {
            const selectedCityElement = document.getElementById('selected-city');
            destination = selectedCityElement ? selectedCityElement.value : 'Not specified';
        } else {
            destination = 'AI will suggest a destination';
        }
        
        const startCityElement = document.getElementById('start-city');
        const durationElement = document.getElementById('duration');
        const seasonElement = document.getElementById('season');
        const peopleElement = document.getElementById('people');
        const budgetElement = document.getElementById('budget');
        const budgetCurrencyElement = document.getElementById('budget-currency');
        
        const startCity = startCityElement ? startCityElement.value : 'Not specified';
        const duration = durationElement ? durationElement.value : 'Not specified';
        const season = seasonElement ? seasonElement.value : 'Not specified';
        const people = peopleElement ? peopleElement.value : 'Not specified';
        const budget = budgetElement ? budgetElement.value : 'Not specified';
        const budgetCurrency = budgetCurrencyElement ? budgetCurrencyElement.value : 'Not specified';
        
        // Debug: Log the values being used for review
        console.log('Review Values:');
        console.log('Destination:', destination);
        console.log('Start City:', startCity);
        console.log('Duration:', duration);
        console.log('Season:', season);
        console.log('People:', people);
        console.log('Budget:', budget);
        console.log('Budget Currency:', budgetCurrency);
        
        // Update review page
        document.getElementById('review-destination').innerText = destination;
        document.getElementById('review-start-city').innerText = startCity;
        document.getElementById('review-duration').innerText = `${duration} days`;
        document.getElementById('review-season').innerText = season;
        document.getElementById('review-people').innerText = `${people} traveler(s)`;
        
        // Format budget text
        let budgetText = '';
        if (budget === 'low') {
            budgetText = 'Low ($)';
        } else if (budget === 'medium') {
            budgetText = 'Medium ($$)';
        } else if (budget === 'high') {
            budgetText = 'High ($$$)';
        }
        
        document.getElementById('review-budget').innerText = `${budgetText} - ${budgetCurrency.toUpperCase()}`;
        
        // Get and format selected interests
        // First make sure our interest selection is up to date by calling getSelectedInterests
        getSelectedInterests();
        
        // Now display the formatted interests on the review page
        const interestItems = document.querySelectorAll('.interest-item.selected');
        const customInterests = document.querySelectorAll('.custom-interest .interest-text');
        
        console.log(`Review: Found ${interestItems.length} selected interest items and ${customInterests.length} custom interests`);
        
        // Format interests for display
        let interestsDisplay = [];
        
        // Add selected grid interests (use the visible label for display)
        interestItems.forEach(function(item) {
            const label = item.querySelector('.interest-label').textContent;
            console.log(`Adding interest label to review: ${label}`);
            interestsDisplay.push(label);
        });
        
        // Add custom interests
        customInterests.forEach(function(item) {
            console.log(`Adding custom interest to review: ${item.textContent}`);
            interestsDisplay.push(item.textContent);
        });
        
        // Display the formatted interests
        let interestsText = interestsDisplay.length > 0
            ? interestsDisplay.join(', ')
            : 'No specific interests selected';
        
        console.log(`Setting review interests text: ${interestsText}`);
        document.getElementById('review-interests').innerText = interestsText;
    }

    async function generatePlan() {
        try {
            // First check if we have an API key
            const apiKeyCheck = await checkApiKey();
            
            if (!apiKeyCheck.success) {
                // Show the API key modal
                const apiKeyModal = document.getElementById('apiKeyModal');
                if (apiKeyModal) {
                    apiKeyModal.style.display = 'block';
                }
                
                // Hide loading
                const loadingState = document.getElementById('loadingState');
                if (loadingState) {
                    loadingState.style.display = 'none';
                }
                return;
            }
            
            // We have an API key, proceed with generation
            // Get destination based on selection
            const destinationTypeRadio = document.querySelector('input[name="destination-type"]:checked');
            if (!destinationTypeRadio) {
                alert('Please select a destination type');
                hideLoading();
                return;
            }
            
            const destinationType = destinationTypeRadio.value;
            let destination = '';
            
            console.log('Destination type selected:', destinationType);
            
            if (destinationType === 'specific') {
                const selectedCityElement = document.getElementById('selected-city');
                if (selectedCityElement) {
                    destination = selectedCityElement.value.trim();
                    console.log('Specific destination selected:', destination);
                    
                    if (!destination) {
                        alert('Please enter a destination city');
                        hideLoading();
                        return;
                    }
                }
            } else {
                // For AI suggestion, we can either send null or a special indicator
                destination = null; // Let the backend know to suggest a destination
                console.log('AI destination suggestion requested');
            }
            
            // Get form values with enhanced debugging and validation
            const startCityElement = document.getElementById('start-city');
            const durationElement = document.getElementById('duration');
            const seasonElement = document.getElementById('season');
            const peopleElement = document.getElementById('people');
            const budgetElement = document.getElementById('budget');
            const budgetCurrencyElement = document.getElementById('budget-currency');
            const specialRequirementsElement = document.getElementById('special-requirements');
            
            // Debug: Log element values before creating data object
            console.log('Form Elements Debug:');
            console.log('Start City:', startCityElement ? startCityElement.value : 'Element not found');
            console.log('Duration:', durationElement ? durationElement.value : 'Element not found');
            console.log('Season:', seasonElement ? seasonElement.value : 'Element not found');
            console.log('People:', peopleElement ? peopleElement.value : 'Element not found');
            console.log('Budget:', budgetElement ? budgetElement.value : 'Element not found');
            console.log('Budget Currency:', budgetCurrencyElement ? budgetCurrencyElement.value : 'Element not found');
            
            // Validate required fields
            if (!startCityElement || !startCityElement.value.trim()) {
                alert('Please enter your starting city');
                hideLoading();
                return;
            }
            
            if (!durationElement || !durationElement.value) {
                alert('Please enter trip duration');
                hideLoading();
                return;
            }
            
            if (!seasonElement || !seasonElement.value) {
                alert('Please select a season');
                hideLoading();
                return;
            }
            
            // Create data object with actual values (no fallbacks to defaults)
            const interestsArray = getSelectedInterests();
            
            const data = {
                start_city: startCityElement.value.trim(),
                duration: parseInt(durationElement.value),
                season: seasonElement.value,
                people: parseInt(peopleElement ? peopleElement.value : 2),
                budget: budgetElement ? budgetElement.value : 'medium',
                budget_currency: budgetCurrencyElement ? budgetCurrencyElement.value : 'usd',
                interests: interestsArray,
                special_requirements: specialRequirementsElement ? specialRequirementsElement.value.trim() || null : null,
                OPENAI_API_KEY: apiKeyCheck.api_key
            };
            
            // Add destination field based on selection type
            if (destination) {
                data.selected_city = destination; // Use 'selected_city' to match backend expectation
            }
            
            // Handle interests - ensure it's always an array
            if (typeof data.interests === 'string') {
                data.interests = data.interests.split(',').map(s => s.trim()).filter(s => s.length > 0);
            } else if (!Array.isArray(data.interests)) {
                data.interests = [];
            }
            
            // Debug: Log the final data object being sent
            console.log('Data being sent to API:', JSON.stringify(data, null, 2));
            
            // Make the generate plan request
            const response = await fetch('/generate_plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            });
            
            // Check for login redirect
            if (response.redirected) {
                window.location.href = response.url;
                return;
            }
            
            const responseData = await response.json();
            
            // Hide the loading overlay
            hideLoading();
            
            if (responseData.error) {
                alert(`Error: ${responseData.error}`);
                return;
            }
            
            // Handle redirection to display_trip route if available
            if (responseData.redirect_url) {
                window.location.href = responseData.redirect_url;
                return;
            }
            
            // If no redirect URL, display the trip details in the current page
            displayTripDetails(responseData);
        } catch (error) {
            hideLoading();
            alert(`Error: ${error.toString()}`);
        }
    }

    // Helper function to hide the loading state safely
    function hideLoading() {
        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
            loadingState.style.display = 'none';
        }
    }
    
    // Function to check if an API key exists in the session
    async function checkApiKey() {
        try {
            const response = await fetch('/get_api_key');
            
            // If we're redirected to login, handle that case
            if (response.redirected) {
                window.location.href = response.url;
                return { success: false };
            }
            
            let text = await response.text();
            
            let data = {};
            try {
                data = JSON.parse(text);
            } catch (e) {
                return { success: false };
            }
            
            if (!data.api_key) {
                return { success: false };
            }
            
            // We have a key in session
            return { success: true, api_key: data.api_key };
        } catch (error) {
            return { success: false, error: error.toString() };
        }
    }
    
    // Function to save API key
    async function saveApiKey() {
        const apiKeyInput = document.getElementById('api-key-input');
        if (!apiKeyInput) {
            alert("API key input not found");
            return;
        }
        
        const apiKey = apiKeyInput.value.trim();
        
        if (!apiKey) {
            alert("Please enter a valid API key");
            return;
        }
        
        try {
            const response = await fetch('/save_api_key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ api_key: apiKey })
            });
            
            if (response.redirected) {
                window.location.href = response.url;
                return;
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Hide modal
                const apiKeyModal = document.getElementById('apiKeyModal');
                if (apiKeyModal) {
                    apiKeyModal.style.display = 'none';
                }
                
                // Show loading again
                const loadingState = document.getElementById('loadingState');
                if (loadingState) {
                    loadingState.style.display = 'block';
                }
                
                // Attempt to generate the plan again
                generatePlan();
            } else {
                alert(`Error saving API key: ${data.error || 'Unknown error'}`);
            }
        } catch (error) {
            alert(`Error: ${error.toString()}`);
        }
    }

    function displayTripDetails(data) {
        // Clear previous trip data
        clearTripDetails();
        
        // Enable result tabs - fix the selector to match the actual element
        const resultTabs = document.querySelector('.result-tabs');
        if (resultTabs) {
            resultTabs.style.display = 'flex';
        }
        
        // Set active tab to overview
        setActiveTab('overview');
        
        // Parse the data
        const tripData = typeof data === 'string' ? JSON.parse(data) : data;
        
        // Store the data globally
        currentTripData = tripData;
        
        // Save to localStorage with plan ID
        saveTripToLocalStorage(tripData);
        
        // Display overview
        populateOverview(tripData);
        
        // Display details for each day
        populateItinerary(tripData);
        
        // Display budget
        populateBudget(tripData);
        
        // Display accommodation
        populateAccommodation(tripData);
        
        // Update title and plan ID
        const resultTitle = document.getElementById('result-title');
        if (resultTitle) {
            resultTitle.innerText = tripData.city_selection?.selected_city || 'Your Itinerary';
        }
        
        const resultDescription = document.getElementById('result-description');
        if (resultDescription) {
            resultDescription.innerText = tripData.overview || 'Your personalized travel plan is ready!';
        }
        
        // Set days count
        const daysCount = tripData.itinerary?.daily_schedules?.length || 0;
        const daysCountElement = document.getElementById('days-count');
        if (daysCountElement) {
            daysCountElement.innerText = daysCount;
        }
        
        // Store plan ID for downloads
        if (tripData.plan_id) {
            const planIdInput = document.getElementById('plan-id-input');
            if (planIdInput) {
                planIdInput.value = tripData.plan_id;
            }
        }
        
        // Scroll to results
        const itineraryResult = document.getElementById('itineraryResult');
        if (itineraryResult) {
            itineraryResult.scrollIntoView({behavior: 'smooth'});
            itineraryResult.style.display = 'block';
        }
    }

    function populateOverview(data) {
        // Set the description
        const summaryText = document.querySelector('.summary-text');
        if (summaryText) {
            const overviewText = data.overview || 'Discover the perfect balance of adventure, culture and relaxation in this tropical paradise.';
            summaryText.innerText = overviewText;
        }
        
        // Populate highlights
        const highlights = data.highlights || [];
        populateHighlights(highlights);
        
        // Get the info grid container
        const infoGrid = document.querySelector('.info-grid');
        if (!infoGrid) return;
        
        // Clear existing content
        infoGrid.innerHTML = '';
        
        // Create an array of card data
        const cardData = [
            {
                icon: 'fas fa-map-marker-alt',
                title: 'Top Attractions',
                items: data.city_research?.attractions || [],
                id: 'attractions-list'
            },
            {
                icon: 'fas fa-utensils',
                title: 'Local Cuisine',
                items: data.city_research?.cuisine || [],
                id: 'cuisine-list'
            },
            {
                icon: 'fas fa-hands',
                title: 'Cultural Tips',
                items: data.city_research?.cultural_norms || [],
                id: 'cultural-list'
            },
            {
                icon: 'fas fa-bed',
                title: 'Accommodation Areas',
                items: data.accommodation?.recommendations || [],
                id: 'accommodation-list'
            },
            {
                icon: 'fas fa-bus',
                title: 'Transportation Tips',
                items: data.city_research?.transportation || [],
                id: 'transportation-list'
            }
        ];
        
        // Create individual info cards and let CSS grid handle the layout
        cardData.forEach(card => {
            const infoCard = createInfoCard(
                card.icon,
                card.title,
                card.items,
                card.id
            );
            
            if (infoCard) {
                infoGrid.appendChild(infoCard);
            }
        });
    }

    function createInfoCard(icon, title, items, listId) {
        const card = document.createElement('div');
        card.className = 'info-card';
        
        const cardHeader = document.createElement('div');
        cardHeader.className = 'info-card-header';
        
        const iconElement = document.createElement('i');
        iconElement.className = icon;
        iconElement.style.color = '#1e73be';
        iconElement.style.marginRight = '10px';
        
        const titleElement = document.createElement('h4');
        titleElement.innerText = title;
        
        cardHeader.appendChild(iconElement);
        cardHeader.appendChild(titleElement);
        
        const cardContent = document.createElement('div');
        cardContent.className = 'info-card-content';
        
        const list = document.createElement('ul');
        list.className = 'info-list';
        list.id = listId;
        
        // Add items to the list
        if (items && items.length > 0) {
            items.forEach(item => {
                const listItem = document.createElement('li');
                listItem.className = 'info-item';
                listItem.innerText = item;
                list.appendChild(listItem);
            });
        } else {
            const listItem = document.createElement('li');
            listItem.className = 'info-item';
            listItem.innerText = 'Information not available';
            list.appendChild(listItem);
        }
        
        cardContent.appendChild(list);
        
        card.appendChild(cardHeader);
        card.appendChild(cardContent);
        
        return card;
    }

    function populateBudget(data) {
        const budget = data.budget || {};
        const budgetTab = document.getElementById('budget-tab');
        
        // Set currency display
        const currency = data.inputs?.budget_currency || budget.currency || 'USD';
        document.getElementById('budget-currency-display').innerText = currency.toUpperCase();
        
        // Set total cost
        const totalCost = budget.total_cost || '0';
        document.getElementById('budget-amount').innerText = totalCost;
        
        // Set budget level
        const budgetLevel = data.inputs?.budget || 'Medium';
        document.getElementById('budget-level').innerText = budgetLevel.charAt(0).toUpperCase() + budgetLevel.slice(1);
        
        // Clear existing breakdown
        const breakdownContainer = document.getElementById('budget-breakdown');
        breakdownContainer.innerHTML = '';
        
        // Get travel cost if it exists
        let travelCost = null;
        let travelDetails = '';
        if (data.travel_cost && data.travel_cost.travel) {
            travelCost = data.travel_cost.travel.cost;
            travelDetails = data.travel_cost.travel.details || '';
        }
        
        // Create expense categories array
        const expenseCategories = [
            { key: 'accommodation', icon: 'fas fa-hotel', color: '#3498db', label: 'Accommodation' },
            { key: 'transportation', icon: 'fas fa-shuttle-van', color: '#2ecc71', label: 'Transportation' },
            { key: 'activities', icon: 'fas fa-hiking', color: '#9b59b6', label: 'Activities' },
            { key: 'meals', icon: 'fas fa-utensils', color: '#e74c3c', label: 'Meals' },
            { key: 'emergency_fund', icon: 'fas fa-first-aid', color: '#f39c12', label: 'Emergency' }
        ];
        
        // Add travel costs as an additional category if it exists
        if (travelCost) {
            expenseCategories.push(
                { key: 'travel', icon: 'fas fa-plane', color: '#1abc9c', label: 'Travel', cost: travelCost, details: travelDetails }
            );
        }
        
        // Calculate total for percentage calculation
        let categoryTotal = 0;
        expenseCategories.forEach(category => {
            const cost = category.cost || (budget[category.key] ? budget[category.key].cost : 0) || 0;
            categoryTotal += parseFloat(cost) || 0;
        });
        
        // If we have no total, use the total_cost instead
        if (categoryTotal === 0 && totalCost) {
            categoryTotal = parseFloat(totalCost) || 0;
        }
        
        // Update the expense breakdown chart
        expenseCategories.forEach(category => {
            // Get the cost
            const cost = category.cost || (budget[category.key] ? budget[category.key].cost : 0) || 0;
            const details = category.details || (budget[category.key] ? budget[category.key].details : '') || '';
            
            // If this category has no cost, skip it
            if (!cost || parseFloat(cost) === 0) return;
            
            // Calculate percentage
            const percentage = categoryTotal > 0 ? (parseFloat(cost) / categoryTotal * 100) : 0;
            
            // Update the chart bar
            const chartBar = document.getElementById(`chart-${category.key}`);
            if (chartBar) {
                chartBar.style.width = Math.max(5, percentage) + '%';
                chartBar.querySelector('.chart-value').innerText = `${currency.toUpperCase()} ${cost}`;
            }
            
            // Create budget category card
            const categoryCard = document.createElement('div');
            categoryCard.className = `budget-category ${category.key}`;
            
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'budget-category-header';
            
            const headerLeft = document.createElement('div');
            headerLeft.innerHTML = `<i class="${category.icon}"></i> ${category.label}`;
            
            const costPill = document.createElement('div');
            costPill.className = 'cost-pill';
            costPill.innerText = `${currency.toUpperCase()} ${cost}`;
            // Use a consistent color for all budget items
            costPill.style.backgroundColor = '#1e73be';
            
            categoryHeader.appendChild(headerLeft);
            categoryHeader.appendChild(costPill);
            
            const categoryContent = document.createElement('div');
            categoryContent.className = 'budget-category-content';
            categoryContent.innerText = details || `Budget allocation for ${category.label.toLowerCase()}.`;
            
            categoryCard.appendChild(categoryHeader);
            categoryCard.appendChild(categoryContent);
            
            breakdownContainer.appendChild(categoryCard);
        });
        
        // Add special note for travel costs if they aren't included in the total
        if (travelCost && !budget.travel) {
            const noteElement = document.createElement('p');
            noteElement.className = 'budget-note';
            noteElement.innerHTML = `<strong>Note:</strong> Travel costs of ${currency.toUpperCase()} ${travelCost} are listed separately and not included in the total budget.`;
            breakdownContainer.appendChild(noteElement);
        }
    }

    function setActiveTab(tabName) {
        // Remove active class from all tabs and tab content
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        if (tabButtons) {
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
        }
        
        if (tabContents) {
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
        }
        
        // Add active class to the selected tab and tab content
        const selectedButton = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
        const selectedContent = document.getElementById(`${tabName}-tab`);
        
        if (selectedButton) {
            selectedButton.classList.add('active');
        }
        
        if (selectedContent) {
            selectedContent.classList.add('active');
        }
    }

    function populateHighlights(items) {
        const container = document.getElementById('highlights-container');
        if (!container) return;
        
        // Clear existing items
        container.innerHTML = '';
        
        // Add each highlight as a tag
        if (items && items.length > 0) {
            items.forEach(item => {
                if (item) {
                    const tag = document.createElement('div');
                    tag.className = 'highlight-tag';
                    tag.innerText = item;
                    container.appendChild(tag);
                }
            });
        } else {
            // If no highlights, add a default message
            const tag = document.createElement('div');
            tag.className = 'highlight-tag';
            tag.innerText = 'Explore local attractions';
            container.appendChild(tag);
        }
    }

    function clearTripDetails() {
        // Clear out any previous data with null checks
        
        // Reset highlights
        const highlightsContainer = document.getElementById('highlights-container');
        if (highlightsContainer) {
            highlightsContainer.innerHTML = '';
        }
        
        // Clear list elements
        const listIds = [
            'attractions-list', 'cuisine-list', 'cultural-list',
            'accommodation-list', 'transportation-list'
        ];
        
        listIds.forEach(id => {
            const list = document.getElementById(id);
            if (list) {
                list.innerHTML = '';
            }
        });
        
        // Clear itinerary container
        const itineraryContainer = document.getElementById('itinerary-container');
        if (itineraryContainer) {
            itineraryContainer.innerHTML = '';
        }
        
        // Reset budget info
        const budgetAmount = document.getElementById('budget-amount');
        if (budgetAmount) {
            budgetAmount.innerText = '0';
        }
        
        const budgetBreakdown = document.getElementById('budget-breakdown');
        if (budgetBreakdown) {
            budgetBreakdown.innerHTML = '';
        }
        
        // Reset chart bars
        const chartIds = [
            'chart-accommodation', 'chart-transportation', 'chart-activities',
            'chart-meals', 'chart-emergency_fund', 'chart-travel'
        ];
        
        chartIds.forEach(id => {
            const chart = document.getElementById(id);
            if (chart) {
                chart.style.width = '5%';
                const chartValue = chart.querySelector('.chart-value');
                if (chartValue) {
                    chartValue.innerText = '';
                }
            }
        });
    }

    function populateItinerary(data) {
        const itineraryContainer = document.getElementById('itinerary-container');
        if (!itineraryContainer) return;
        
        // Clear existing content
        itineraryContainer.innerHTML = '';
        
        // Get the daily schedules
        const dailySchedules = data.itinerary?.daily_schedules || [];
        
        if (dailySchedules.length === 0) {
            // Display a message if no itinerary data
            const message = document.createElement('div');
            message.className = 'no-data-message';
            message.innerHTML = '<p>No itinerary data available.</p>';
            itineraryContainer.appendChild(message);
            return;
        }
        
        // Loop through each day
        dailySchedules.forEach(day => {
            // Create day container
            const dayContainer = document.createElement('div');
            dayContainer.className = 'day-container';
            
            // Create day header
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            
            const dayTitle = document.createElement('h3');
            dayTitle.innerText = `Day ${day.day}`;
            dayHeader.appendChild(dayTitle);
            
            dayContainer.appendChild(dayHeader);
            
            // Add activities
            const activities = day.activities || [];
            activities.forEach(activity => {
                // Create activity item
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                // Create time element
                const timeElement = document.createElement('div');
                timeElement.className = 'activity-time';
                timeElement.innerText = activity.time || 'Flexible';
                
                // Create details element
                const detailsElement = document.createElement('div');
                detailsElement.className = 'activity-details';
                
                // Create name element
                const nameElement = document.createElement('div');
                nameElement.className = 'activity-name';
                nameElement.innerText = activity.activity || 'Untitled Activity';
                
                // Create location element
                const locationElement = document.createElement('div');
                locationElement.className = 'activity-location';
                locationElement.innerText = activity.location || 'Location not specified';
                
                // Add all elements to the activity item
                detailsElement.appendChild(nameElement);
                detailsElement.appendChild(locationElement);
                
                // Add transport info if available
                if (activity.transport) {
                    const transportElement = document.createElement('div');
                    transportElement.className = 'activity-transport';
                    transportElement.innerHTML = `<i class="fas fa-bus"></i> ${activity.transport}`;
                    detailsElement.appendChild(transportElement);
                }
                
                activityItem.appendChild(timeElement);
                activityItem.appendChild(detailsElement);
                
                dayContainer.appendChild(activityItem);
            });
            
            // Add day container to itinerary
            itineraryContainer.appendChild(dayContainer);
        });
    }

    function populateAccommodation(data) {
        // This function will populate accommodation data
        // Only if there's specific accommodation data to show
        const accommodationData = data.accommodation || {};
        
        // We already display accommodation areas in the overview info cards
        // So we'll just update any specific accommodation recommendations if they exist
        const accommodationList = document.getElementById('accommodation-list');
        if (!accommodationList) return;
        
        // If we have specific recommendations, add them
        const recommendations = accommodationData.recommendations || [];
        if (recommendations.length > 0) {
            // Clear existing list
            accommodationList.innerHTML = '';
            
            // Add each recommendation
            recommendations.forEach(recommendation => {
                const item = document.createElement('li');
                item.className = 'info-item';
                item.innerText = recommendation;
                accommodationList.appendChild(item);
            });
        }
    }

    // LocalStorage utility functions for trip plans
    function saveTripToLocalStorage(tripData) {
        try {
            if (!tripData || !tripData.plan_id) {
                console.warn('Cannot save trip: missing plan_id');
                return;
            }
            
            // Get existing saved plans or initialize empty object
            const savedPlans = JSON.parse(localStorage.getItem('savedTripPlans') || '{}');
            
            // Add or update the plan
            savedPlans[tripData.plan_id] = {
                ...tripData,
                savedAt: new Date().toISOString(),
                userId: getCurrentUserId() // We'll implement this function
            };
            
            // Save back to localStorage
            localStorage.setItem('savedTripPlans', JSON.stringify(savedPlans));
            
            console.log(`Trip plan ${tripData.plan_id} saved to localStorage`);
            
            // Show success message
            showNotification('Trip plan saved successfully!', 'success');
            
        } catch (error) {
            console.error('Error saving trip to localStorage:', error);
            showNotification('Error saving trip plan', 'error');
        }
    }
    
    function loadTripFromLocalStorage(planId) {
        try {
            const savedPlans = JSON.parse(localStorage.getItem('savedTripPlans') || '{}');
            
            if (savedPlans[planId]) {
                const tripData = savedPlans[planId];
                console.log(`Loading trip plan ${planId} from localStorage`);
                
                // Display the trip
                displayTripDetails(tripData);
                
                // Show success message
                showNotification('Trip plan loaded successfully!', 'success');
                
                return tripData;
            } else {
                console.warn(`Trip plan ${planId} not found in localStorage`);
                showNotification('Trip plan not found', 'warning');
                return null;
            }
        } catch (error) {
            console.error('Error loading trip from localStorage:', error);
            showNotification('Error loading trip plan', 'error');
            return null;
        }
    }
    
    function getAllSavedPlans() {
        try {
            const savedPlans = JSON.parse(localStorage.getItem('savedTripPlans') || '{}');
            const currentUserId = getCurrentUserId();
            
            // Filter plans by current user
            const userPlans = {};
            Object.keys(savedPlans).forEach(planId => {
                if (savedPlans[planId].userId === currentUserId) {
                    userPlans[planId] = savedPlans[planId];
                }
            });
            
            return userPlans;
        } catch (error) {
            console.error('Error getting saved plans:', error);
            return {};
        }
    }
    
    function clearSavedPlans() {
        try {
            localStorage.removeItem('savedTripPlans');
            console.log('All saved trip plans cleared from localStorage');
        } catch (error) {
            console.error('Error clearing saved plans:', error);
        }
    }
    
    function getCurrentUserId() {
        // Get user ID from session storage
        return sessionStorage.getItem('currentUserId') || 'anonymous';
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <span>${message}</span>
            <button class="notification-close" onclick="this.parentElement.remove()">×</button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Function to prompt user for plan ID to load
    function promptLoadPlan() {
        const planId = prompt('Enter the Plan ID to load:');
        if (planId && planId.trim()) {
            loadTripFromLocalStorage(planId.trim());
        }
    }
    
    // Function to show all saved plans
    function showSavedPlans() {
        const savedPlans = getAllSavedPlans();
        const planIds = Object.keys(savedPlans);
        
        if (planIds.length === 0) {
            alert('No saved trip plans found.');
            return;
        }
        
        let message = 'Saved Trip Plans:\n\n';
        planIds.forEach(planId => {
            const plan = savedPlans[planId];
            const destination = plan.city_selection?.selected_city || 'Unknown destination';
            const savedDate = new Date(plan.savedAt).toLocaleDateString();
            message += `• ${planId}: ${destination} (saved ${savedDate})\n`;
        });
        
        message += '\nCopy a Plan ID to load it using the "Load Saved Plan" button.';
        alert(message);
    }
    
    // Initialize user ID when page loads
    function initializeUser() {
        // Generate a more stable user identifier
        if (!sessionStorage.getItem('currentUserId')) {
            // Try to get user info from the DOM (if available)
            const userNameElement = document.querySelector('.user-profile span');
            let userId = 'anonymous';
            
            if (userNameElement) {
                // If user is logged in, use their name + timestamp for uniqueness
                userId = userNameElement.textContent.trim().replace(/\s+/g, '_').toLowerCase() + '_' + Date.now();
            } else {
                // For anonymous users, create a session-based identifier
                userId = 'user_' + Date.now();
            }
            
            sessionStorage.setItem('currentUserId', userId);
        }
    }
    
    // Clear localStorage when user logs out
    function handleLogout() {
        clearSavedPlans();
        sessionStorage.removeItem('currentUserId');
        console.log('User logged out, localStorage cleared');
    }
    
    // ... existing code ...
</script>

<script src="{{ url_for('static', filename='js/interests.js') }}"></script>
<script src="{{ url_for('static', filename='js/trip_display.js') }}"></script>
{% endblock %}

<!-- Add this script near the end of the file, before the closing </body> tag -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if test_plan data is available
        const testPlanData = '{{ test_plan|safe }}';
        if (testPlanData && testPlanData !== '{{ test_plan|safe }}') {
            try {
                const planData = JSON.parse(testPlanData);
                console.log('Test plan data loaded:', planData);
                // Display the plan
                displayTripDetails(planData);
            } catch (error) {
                console.error('Error parsing test plan data:', error);
            }
        }
    });
</script>
